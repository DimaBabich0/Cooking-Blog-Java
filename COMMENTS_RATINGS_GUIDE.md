# Руководство по комментариям и рейтингам

## Описание

Система комментариев и рейтингов для рецептов и блогов.

## Что было реализовано

### Бэкенд

1. **Модели** (`Comment.java`, `Rating.java`):
   - Поддержка рецептов (`recipe_id`) и блогов (`blog_id`)
   - Оба поля опциональны, но одно из них должно быть заполнено

2. **Репозитории**:
   - `findByRecipeId()` - поиск комментариев/рейтингов по рецепту
   - `findByBlogId()` - поиск комментариев/рейтингов по блогу
   - `findByUserIdAndRecipeId()` - поиск рейтинга пользователя для рецепта
   - `findByUserIdAndBlogId()` - поиск рейтинга пользователя для блога

3. **Сервисы**:
   - `findByRecipeId()` / `findByBlogId()` - получение списка
   - `getAverageRatingByRecipe()` / `getAverageRatingByBlog()` - средний рейтинг
   - Автоматическое обновление существующего рейтинга при повторной оценке

4. **Контроллеры**:
   - `GET /api/comments/recipe/{recipeId}` - комментарии рецепта
   - `GET /api/comments/blog/{blogId}` - комментарии блога
   - `GET /api/ratings/recipe/{recipeId}` - рейтинги рецепта
   - `GET /api/ratings/blog/{blogId}` - рейтинги блога
   - `GET /api/ratings/recipe/{recipeId}/average` - средний рейтинг рецепта
   - `GET /api/ratings/blog/{blogId}/average` - средний рейтинг блога
   - `GET /api/ratings/user/{userId}/recipe/{recipeId}` - рейтинг пользователя для рецепта
   - `GET /api/ratings/user/{userId}/blog/{blogId}` - рейтинг пользователя для блога

### Фронтенд

1. **API** (`commentApi.ts`, `ratingApi.ts`):
   - Оптимизированные запросы (прямые эндпоинты вместо фильтрации на клиенте)
   - Обработка ошибок

2. **Компоненты**:
   - `Rating` - компонент рейтинга (5 звезд)
   - `Comments` - компонент комментариев (список + форма)

3. **Интеграция**:
   - Компоненты добавлены на страницы рецептов и блогов
   - Отображаются после основного контента

## Миграция базы данных

**ВАЖНО**: Перед использованием необходимо выполнить SQL миграцию:

```sql
-- Файл: CB_Backend/src/main/resources/migration_add_blog_id_to_comments_ratings.sql
```

Миграция добавляет:
- Колонку `blog_id` в таблицы `CB_COMMENTS` и `CB_RATINGS`
- Делает `recipe_id` опциональным
- Добавляет внешние ключи
- Добавляет проверки (либо recipe_id, либо blog_id)

## Функциональность

### Комментарии

- ✅ Просмотр всех комментариев для рецепта/блога
- ✅ Добавление нового комментария (требуется авторизация)
- ✅ Удаление своего комментария
- ✅ Отображение автора, аватара, даты
- ✅ Сортировка по дате (новые сверху)

### Рейтинги

- ✅ Отображение среднего рейтинга и количества оценок
- ✅ Оценка от 1 до 5 звезд (требуется авторизация)
- ✅ Обновление существующей оценки (не создает дубликаты)
- ✅ Подсветка звезд при наведении
- ✅ Отображение рейтинга пользователя (если есть)

## Проверка работы

1. **Выполните миграцию БД** (если еще не выполнена)

2. **Проверьте бэкенд**:
   - Запустите приложение
   - Проверьте эндпоинты через Postman или браузер

3. **Проверьте фронтенд**:
   - Откройте страницу рецепта или блога
   - Попробуйте оставить комментарий (нужна авторизация)
   - Попробуйте поставить рейтинг (нужна авторизация)
   - Проверьте обновление рейтинга при повторной оценке

## Возможные проблемы

1. **Ошибка "Either recipeId or blogId must be provided"**:
   - Убедитесь, что передается либо `recipeId`, либо `blogId`

2. **Ошибка "User not found"**:
   - Убедитесь, что пользователь авторизован и существует в БД

3. **Комментарии/рейтинги не отображаются**:
   - Проверьте консоль браузера на ошибки
   - Проверьте, что миграция БД выполнена
   - Проверьте, что бэкенд запущен

4. **Дубликаты рейтингов**:
   - Система автоматически обновляет существующий рейтинг
   - Если проблема сохраняется, проверьте логику в `RatingService.create()`
